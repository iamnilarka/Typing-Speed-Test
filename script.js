const paragraphsByDuration = {
    60: [
        "The morning sun cast golden rays across the peaceful garden. Birds chirped melodiously while butterflies danced among colorful flowers. A gentle breeze carried the sweet scent of blooming roses. The leaves rustled softly, adding to the tranquil atmosphere. Dewdrops glistened on blades of grass, reflecting light like tiny gems. A cat stretched lazily on the sunlit path.",

        "Technology shapes our modern world in fascinating ways. Smartphones connect people globally, and artificial intelligence solves complex problems. These innovations transform daily life, offering convenience and efficiency. However, rapid advancements pose ethical dilemmas. Privacy concerns grow as data collection expands. Balancing progress with responsibility is crucial. Society must navigate the challenges of an increasingly digital future while harnessing its benefits wisely.",
        "Ocean waves crashed against the rocky shoreline, spraying salty mist into the air. Seagulls soared overhead, scanning for food. The beach stretched endlessly ahead, with pristine sand reflecting the sunlight. Children built sandcastles near the water's edge. A distant ship sailed toward the horizon. The rhythmic sound of waves created a soothing background melody for visitors.",

        "Mountain climbers faced the challenging ascent with determination. Their equipment jingled with each careful step upward. The summit loomed through misty clouds, promising breathtaking views. Ropes secured their progress, ensuring safety. Each climber relied on teamwork and endurance. The thin air made breathing difficult, but perseverance drove them forward. Reaching the peak was the ultimate reward.",

        "The local farmers market bustled with activity. Fresh fruits and vegetables filled wooden stalls, their colors vibrant under the morning sun. Artisans displayed handcrafted jewelry and pottery. Shoppers sampled homemade treats, savoring the flavors. Musicians played cheerful melodies, adding to the lively atmosphere. Conversations buzzed as people exchanged smiles and greetings. The community gathered in celebration of local produce.",

        "A library's quiet ambiance encouraged deep concentration. Rows of books lined the shelves, containing knowledge from various fields. Students studied diligently at long wooden tables. A librarian carefully sorted returned books, placing them back in order. Sunlight streamed through tall windows, illuminating dust particles in the air. The scent of old paper filled the room, evoking a timeless charm.",

        "The park provided a serene escape from the city's hustle. Joggers moved along winding paths lined with towering trees. Ducks glided gracefully across the pond's surface. Children played on swings, their laughter echoing. Benches offered rest to those enjoying the fresh air. A street performer entertained passersby with skillful tricks. The peaceful environment invited reflection and relaxation."
    ],
    120: [
        "The bustling city slowly awakened as dawn painted the sky in hues of orange and pink. Commuters hurried along sidewalks, clutching steaming cups of coffee. Street vendors arranged fresh produce while buses hissed at crowded stops. Neon signs dimmed as daylight revealed intricate architectural details. A street cleaner methodically swept debris into a cart. In parks, tai chi practitioners moved in synchronized patterns. The aroma of freshly baked bread wafted from corner bakeries. Pigeons scattered as bicycles zipped through narrow lanes. Office workers glanced at watches, accelerating their pace. The urban symphony of honking horns and chatter grew louder, signaling the full arrival of morning.",
        
        "Biodiversity forms Earth's intricate web of life, where each species plays a vital role. Pollinators like bees ensure food crops flourish, while predators maintain ecological balance. Coral reefs teem with marine creatures, their vibrant ecosystems filtering ocean waters. Deforestation disrupts these networks, causing irreversible chain reactions. Conservationists work tirelessly to protect endangered habitats through reforestation projects. Climate change alters migration patterns, forcing animals to adapt rapidly. Public awareness campaigns emphasize sustainable practices to preserve natural wonders. Protecting biodiversity safeguards humanity's future food sources and medical discoveries.",
        
        "A handwritten letter carries unique emotional weight in our digital age. The sender carefully selects stationery, contemplating each inked word. Receivers treasure the tactile experience-the texture of paper, the personality in pen strokes. Letters become keepsakes, stored in memory boxes for decades. They capture historical moments through personal perspectives, unlike transient emails. Elderly relatives especially appreciate this tangible connection. Though slower, this method fosters deeper reflection and intentional communication. Society risks losing this art form as technology prioritizes speed over substance.",
        
        "Traditional festivals illuminate cultural heritage through vibrant celebrations. In India, Diwali's oil lamps symbolize light conquering darkness, while fireworks paint the night sky. Mexico's Día de Muertos features elaborate altars honoring ancestors with marigolds and favorite foods. Japan's cherry blossom festivals celebrate transient beauty with picnic gatherings under pink canopies. These events preserve ancient customs through music, dance, and shared meals. Younger generations learn ancestral stories, strengthening community bonds. Globalization threatens some traditions, making their preservation through participation more crucial than ever.",
        
        "Deep-sea exploration reveals alien-like creatures in crushing darkness. Submersibles equipped with spotlights capture bioluminescent jellyfish and anglerfish. Hydrothermal vents host extremophiles thriving in boiling, mineral-rich waters. Scientists discover potential medical breakthroughs in marine organisms' unique biochemistry. The ocean floor's mysterious terrain holds clues to Earth's geological history. However, plastic waste now contaminates even these remote depths. International collaborations aim to map uncharted regions while advocating for marine conservation. Each dive brings humanity closer to understanding our planet's final frontier."
    ],
    180: [
        "Education systems worldwide face transformative challenges in the 21st century. Traditional classrooms, once rows of desks facing chalkboards, now incorporate virtual reality and AI tutors. Teachers curate digital resources while nurturing critical thinking over rote memorization. Students from remote villages access Ivy League lectures via MOOCs, democratizing knowledge. However, the digital divide exacerbates inequalities-underfunded schools lack reliable internet, while privileged peers code robots. Socioemotional learning gains importance as automation reshapes careers. Schools teach resilience and adaptability alongside mathematics. Policymakers debate standardized testing's relevance in assessing creativity. Parent-teacher collaborations strengthen through real-time progress apps. Meanwhile, vocational training resurges, bridging the gap between academia and industry needs. Lifelong learning becomes essential as careers span multiple fields. The future demands education that balances technological prowess with ethical reasoning and cultural empathy.",
        
        "Climate change manifests dramatically in polar regions. Arctic permafrost thaws, releasing methane that accelerates global warming. Polar bears swim farther between shrinking ice floes, struggling to hunt seals. Indigenous communities lose ancestral hunting grounds to erratic weather patterns. Scientists drill ice cores, uncovering 800,000 years of atmospheric data. Albedo effect diminishes as dark meltwater absorbs more heat than reflective snow. Cruise ships now traverse once-impassable Northwest Passage routes, risking oil spills. International treaties aim to protect these fragile ecosystems, but enforcement remains challenging. Satellite imagery reveals glacial retreat at alarming rates-Greenland loses billions of tons of ice daily. Researchers camp on floating ice sheets, collecting data in minus 40°C. Their findings urge immediate emission reductions to prevent catastrophic sea level rise.",
        
        "The Renaissance reshaped Europe through an explosion of art and science. Florence became a hub where da Vinci dissected cadavers to perfect anatomy sketches. Guttenberg's printing press spread ideas rapidly, challenging Church authority. Patrons like the Medici funded Michelangelo's David, symbolizing human potential. Scientists like Galileo faced persecution for heliocentric theories. Vernacular literature flourished with Dante and Chaucer, making knowledge accessible beyond Latin. Trade routes brought spices, silk, and new perspectives from the East. Architecture blended classical symmetry with innovative domes and columns. This cultural rebirth stemmed from post-plague optimism and rediscovered Greek texts. However, it also bred conflict between emerging nation-states and colonial ambitions. The era's legacy lies in its celebration of inquiry-a foundation for modern thought.",
        
        "Urban farming revolutionizes city landscapes with rooftop gardens and vertical hydroponics. Skyscrapers grow lettuce in LED-lit tiers, reducing transport emissions. Beekeepers install hives on corporate buildings, boosting pollination in concrete jungles. Community gardens transform vacant lots into social hubs where neighbors exchange gardening tips. Children learn about food sources by tending tomato plants beside parking garages. Rainwater harvesting systems irrigate these oases sustainably. Restaurants pride themselves on hyper-local ingredients-microgreens harvested hours before serving. While space constraints limit yields, these projects shift mindsets about self-sufficiency. They combat food deserts in low-income areas, providing fresh produce. Urban planners integrate agricultural spaces into smart city designs, redefining metropolitan sustainability.",
        
        "Quantum computing promises to solve problems deemed impossible for classical computers. Qubits exploit superposition, existing in multiple states simultaneously. Entanglement links particles across distances, enabling ultra-secure communication. Laboratories maintain near-absolute-zero temperatures to stabilize fragile quantum states. Pharmaceutical companies simulate molecular interactions for breakthrough drugs. Logistics firms optimize global shipping routes in seconds. However, quantum systems threaten current encryption methods, prompting a cybersecurity arms race. Tech giants and startups invest billions in this race for “quantum supremacy.” Ethical frameworks lag behind, raising questions about data privacy and algorithmic bias. The technology remains embryonic, but its potential to revolutionize fields from cryptography to climate modeling captivates scientists worldwide."
    ],
    300: [
        "The Industrial Revolution marked humanity's seismic shift from agrarian societies to mechanized production. Beginning in 18th-century Britain, water wheels and steam engines powered textile mills that operated day and night. Canals and railways connected mines to factories, creating national markets. Urban populations ballooned as peasants sought factory jobs, often facing grueling 16-hour shifts in hazardous conditions. Child labor became widespread, depicted heartbreakingly in novels by Dickens and Brontë. Pollution blackened skies-London's “pea soup” fog caused respiratory epidemics. Yet innovation flourished: Bessemer's steel process enabled skyscrapers, and Morse's telegraph shrank communication gaps. Labor unions emerged, fighting for weekends and safety regulations. The revolution's dual legacy birthed modern capitalism and socialist critiques. Colonial resources fueled growth, entrenching global inequities. Women entered factories, sparking early feminist movements. Art responded with Romanticism's nature nostalgia and Realism's gritty depictions. This era's triumphs and tragedies shaped contemporary debates about automation, workers' rights, and environmental stewardship.",
        
        "Human space exploration evolved from Cold War competition to international collaboration. Sputnik's 1957 beep ignited the space race, culminating in Apollo 11's lunar landing. Armstrong's “giant leap” televised globally, inspiring STEM careers worldwide. Space shuttles enabled satellite deployment and Hubble's cosmic snapshots. The ISS became a symbol of unity, hosting astronauts from rival nations. Private companies now vie for Mars colonization, promising passenger flights. Challenges abound: cosmic radiation, muscle atrophy, and psychological strain in confinement. Lunar bases could test sustainable closed ecosystems using regolith-grown crops. Asteroid mining proposes harvesting platinum for Earth's tech industry. Debris from old satellites orbits dangerously, requiring cleanup missions. Ethical questions arise about contaminating alien biospheres or claiming celestial resources. Meanwhile, probes like Voyager carry golden records of Earth's sounds, drifting toward interstellar space. Astronomers peer into exoplanet atmospheres, seeking biosignatures. Whether driven by curiosity, profit, or survival, humanity's cosmic ambitions reflect our restless ingenuity.",
        
        "Globalization weaves economies and cultures into an interdependent tapestry. Container ships transport Vietnamese coffee to European cafes, while K-pop tops Canadian charts. Multilingual call centers operate 24/7, dissolving time zones. Critics argue this erodes local traditions-family-owned shops succumb to supermarket chains. Sweatshops in developing nations fuel fast fashion, raising ethical consumption debates. Yet globalization also empowers: social media unites diaspora communities and amplifies marginalized voices. Pandemics demonstrate its fragility-a Wuhan virus halts New York theaters. Climate accords like Paris 2015 require unprecedented cooperation, yet national interests often stall progress. Migrants remit earnings home, reshaping villages with concrete homes and satellite dishes. UNESCO protects endangered languages and heritage sites from homogenization. The internet's “flat world” myth clashes with digital borders-China's Great Firewall, EU's GDPR. As artificial intelligence automates translation, cultural nuances risk flattening. Youth navigate hybrid identities, code-switching between local customs and global trends. This complex web demands balancing economic growth with cultural preservation and equitable resource distribution.",
        
        "Neuroscience unravels the brain's mysteries, revealing astonishing plasticity. fMRI scans show neural pathways rewiring in response to learning-a violinist's motor cortex expands with practice. Neuroprosthetics allow paralyzed patients to control robotic arms via brain implants. Depression is redefined as synaptic imbalance, treated with targeted magnetic stimulation. Alzheimer's research focuses on beta-amyloid plaques, while lifestyle interventions delay cognitive decline. Mirror neurons explain empathy's biological basis, fostering anti-violence programs. Ethical dilemmas emerge: Should brain scans predict criminal tendencies? Memory-erasing drugs could treat PTSD but enable manipulation. “Smart drugs” like Modafinil boost focus, widening achievement gaps. Psychedelics reenter clinical trials for treating addiction under controlled settings. AI decodes neural patterns to reconstruct imagined speech, aiding locked-in patients. Meanwhile, meditation studies prove mindfulness physically thickens the prefrontal cortex. These advances challenge notions of free will and identity, urging legal systems to adapt. As brain-computer interfaces evolve, humanity stands at the threshold of merging biology with technology.",
    ]
};


// State variables
let currentParagraph = "";
let timer;
let timerInterval = null;
let isTyping = false;
let startTime;
let errorPositions = new Set();
let permanentErrors = new Set();
let totalKeystrokes = 0;
let correctKeystrokes = 0;

// Audio elements
const countdownSound = new Audio('countdown.mp3');
const endSound = new Audio('end.mp3');

// DOM elements
const quoteElement = document.getElementById("quote");
const inputElement = document.getElementById("input");
const wpmElement = document.getElementById("wpm");
const cpmElement = document.getElementById("cpm");
const accuracyElement = document.getElementById("accuracy");
const errorsElement = document.getElementById("errors");
const startButton = document.getElementById("start");
const resetButton = document.getElementById("reset");
const timeSelect = document.getElementById("time-select");

// Add modal HTML
const modalHTML = `
<div id="resultsModal" class="modal">
    <div class="modal-content">
        <h2>Test Results</h2>
        <div class="results-grid">
            <div class="result-item">
                <h3>WPM</h3>
                <p id="modalWpm">0</p>
            </div>
            <div class="result-item">
                <h3>CPM</h3>
                <p id="modalCpm">0</p>
            </div>
            <div class="result-item">
                <h3>Accuracy</h3>
                <p id="modalAccuracy">0%</p>
            </div>
            <div class="result-item">
                <h3>Errors</h3>
                <p id="modalErrors">0</p>
            </div>
        </div>
        <button id="closeModal" class="close-button">Close</button>
        <button id="retryTest" class="retry-button">Try Again</button>
    </div>
</div>`;

document.body.insertAdjacentHTML('beforeend', modalHTML);

// Modal elements
const modal = document.getElementById("resultsModal");
const closeModal = document.getElementById("closeModal");
const retryTest = document.getElementById("retryTest");

// Timer functions
function updateTimerDisplay() {
    const selectedTime = parseInt(timeSelect.value);
    const minutes = Math.floor(selectedTime / 60);
    const seconds = selectedTime % 60;
    document.getElementById("timer").textContent = 
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// Paragraph handling
function getRandomParagraph() {
    const selectedTime = parseInt(timeSelect.value);
    const paragraphSet = paragraphsByDuration[selectedTime];
    return paragraphSet[Math.floor(Math.random() * paragraphSet.length)];
}

function displayParagraph() {
    currentParagraph = getRandomParagraph();
    quoteElement.innerHTML = currentParagraph.split('').map(char => 
        `<span>${char}</span>`
    ).join('');
}

// Test controls
function startCountdown() {
    let count = 5;
    startButton.disabled = true;
    
    const countdownInterval = setInterval(() => {
        if (count > 0) {
            countdownSound.play();
            quoteElement.innerHTML = `<h1>${count}</h1>`;
            count--;
        } else {
            clearInterval(countdownInterval);
            startTest();
        }
    }, 1000);
}

function startTest() {
    isTyping = true;
    inputElement.disabled = false;
    inputElement.value = "";
    inputElement.focus();
    displayParagraph();
    startTime = Date.now(); // More precise timestamp
    errorPositions.clear();
    permanentErrors.clear();
    totalKeystrokes = 0;
    correctKeystrokes = 0;

    // Unified time tracking
    timer = parseInt(timeSelect.value);
    timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const remaining = timer - elapsed;
        
        if (remaining <= 0) {
            endTest();
        } else {
            document.getElementById("timer").textContent = formatTime(remaining);
        }
    }, 200);
}

function endTest() {
    isTyping = false;
    clearInterval(timerInterval);
    inputElement.disabled = true;
    startButton.disabled = false;
    endSound.play();
    calculateStats();
    showResults();
}

function resetTest() {
    clearInterval(timerInterval);
    isTyping = false;
    timer = parseInt(timeSelect.value);
    errorPositions.clear();
    permanentErrors.clear();
    totalKeystrokes = 0;
    correctKeystrokes = 0;
    
    updateTimerDisplay();
    wpmElement.textContent = "0";
    cpmElement.textContent = "0";
    accuracyElement.textContent = "0";
    errorsElement.textContent = "0";
    
    inputElement.value = "";
    inputElement.disabled = true;
    startButton.disabled = false;
    quoteElement.innerHTML = "";
    displayParagraph();
}

// Statistics calculations
function calculateStats() {
    const elapsedSeconds = (Date.now() - startTime) / 1000;
    const timeMinutes = elapsedSeconds / 60;

    const grossWPM = Math.round((totalKeystrokes / 5) / timeMinutes);
    const netWPM = Math.round((correctKeystrokes / 5) / timeMinutes);
    const accuracy = totalKeystrokes > 0 
        ? Math.round((correctKeystrokes / totalKeystrokes) * 100)
        : 0;

    // Use netWPM for final score
    wpmElement.textContent = netWPM;
    cpmElement.textContent = Math.round(correctKeystrokes / timeMinutes);
    accuracyElement.textContent = accuracy;
    errorsElement.textContent = permanentErrors.size;
}

function showResults() {
    document.getElementById("modalWpm").textContent = wpmElement.textContent;
    document.getElementById("modalCpm").textContent = cpmElement.textContent;
    document.getElementById("modalAccuracy").textContent = accuracyElement.textContent + "%";
    document.getElementById("modalErrors").textContent = errorsElement.textContent;
    modal.style.display = "flex";
}

// Input handling
inputElement.addEventListener("input", (e) => {
    if (!isTyping) return;

    const inputValue = inputElement.value;
    const quoteSpans = quoteElement.querySelectorAll("span");
    
    // Early completion check
    if (inputValue === currentParagraph) {
        endTest();
        return;
    }

    // Real-time error tracking
    const currentPos = inputValue.length - 1;
    
    if (e.inputType !== "deleteContentBackward") {
        totalKeystrokes++;
        if (inputValue[currentPos] === currentParagraph[currentPos]) {
            correctKeystrokes++;
        } else {
            permanentErrors.add(currentPos);
        }
    }

    // Visual feedback
    quoteSpans.forEach((span, index) => {
        const char = inputValue[index];
        span.classList.remove("correct", "incorrect", "corrected", "current");
        
        if (char) {
            if (char === currentParagraph[index]) {
                // Check if this position had a previous error
                span.classList.add(permanentErrors.has(index) ? "corrected" : "correct");
            } else {
                span.classList.add("incorrect");
            }
        } else if (index === inputValue.length) {
            span.classList.add("current");
        }
    });

    calculateStats();
});

// Event listeners
startButton.addEventListener("click", startCountdown);
resetButton.addEventListener("click", resetTest);
closeModal.addEventListener("click", () => modal.style.display = "none");
retryTest.addEventListener("click", () => {
    modal.style.display = "none";
    resetTest();
    startCountdown();
});
window.addEventListener("click", (event) => {
    if (event.target === modal) modal.style.display = "none";
});
timeSelect.addEventListener("change", updateTimerDisplay);

// Styles
const style = document.createElement('style');
style.textContent = `
    .correct { color: #2ecc71; }
    .incorrect { color: #e74c3c; }
    .corrected { color: #f1c40f; }
    .current { 
        background-color: #bdc3c7;
        border-radius: 2px;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background-color: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 500px;
        width: 90%;
    }

    .results-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin: 2rem 0;
    }

    .result-item {
        padding: 1rem;
        border-radius: 8px;
        background-color: #f8f9fa;
    }

    .result-item h3 {
        color: #666;
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
    }

    .result-item p {
        color: #2c3e50;
        font-size: 1.5rem;
        font-weight: bold;
        margin: 0;
    }

    .close-button, .retry-button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        margin: 0 0.5rem;
        transition: background-color 0.2s;
    }

    .close-button {
        background-color: #e74c3c;
        color: white;
    }

    .retry-button {
        background-color: #2ecc71;
        color: white;
    }

    .close-button:hover {
        background-color: #c0392b;
    }

    .retry-button:hover {
        background-color: #27ae60;
    }

    .modal-content h2 {
        color: #2c3e50;
        margin: 0 0 1rem 0;
    }`;
document.head.appendChild(style);

// Initial setup
displayParagraph();
updateTimerDisplay();